{% extends 'layout.html' %}

{% block content %}

<script src="http://localhost:3300/socket.io/socket.io.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src="/public/javascripts/gmaps.js"></script>
<style type="text/css">
    #map {
      width: 100%;
      height: 600px;
    }
  </style>
<script>

	var map;
	var makers = [];

	$(document).ready(function(){

		map = new GMaps({
			div: '#map',
			zoom: 6,
			lat: -42,
			lng: -71
		});

		{% for comuna in comunas %}

			var m = map.addMarker({
				lat: {{comuna.point_geom[0]['latitud']}},
				lng: {{comuna.point_geom[0]['longitud']}},
				title: '{{comuna.nombre}}',
				icon: '/public/images/boton_verde.png',
				id: '{{comuna.id}}',
				click: function (e){
					//$('#encabezado').empty();
					//$('#encabezado').append('{{comuna.nombre}}');
					$('#encabezado').html('{{comuna.nombre}}');
					$('#latitud').html('{{comuna.point_geom[0]['latitud']}}');
					$('#longitud').html('{{comuna.point_geom[0]['longitud']}}');
					$('#local').html('{{comuna.localidad}}');
					$('#dep').html('{{comuna.departamento}}');
					$('#habitantes').html('{{comuna.poblacion}}');
					$('#encargado').html('{{comuna.encargado}}');
					$.ajax({
	  					url: "/comunas/{{comuna.id}}/getGeneradores",
	  					type: "GET",
	  					data: {},
	  					success: function(data) {
	  						$('#tableG').html(data);
	  					}
  					});
					$('#modal').modal('show');
					//$('#nombre').replaceWith('{{comuna.nombre}}');
				},
			});
			makers.push(m);
		{% endfor %}

		{% for comuna in comunas %}

			$.ajax({
				url: "/comunas/{{comuna.id}}/getEstadoGenerador",
				type: "GET",
				data: {},
				success: function(activado) {
					for (i = 0; i < makers.length; i++){
						if ('{{comuna.id}}' == makers[i].id){
							var e = makers[i];
							if (activado) {
								e.icon = '/public/images/boton_rojo.png';
								map.removeMarker(makers[i]);
								map.addMarker(e);
							}
						}
					}		
				}
			});
		{% endfor %}
	});

	function verDatos(id){
		location.href = "/aerogenerador/" + id;
	};

	function prueba() {
		/*var e = makers[0];
		e.icon = '/public/images/boton_rojo.png';
		map.removeMarker(makers[0]);
		map.addMarker(e);
		alert(e.id);*/
	}

	{% if user.suscripciones.indexOf('aerogenerador/clima') !== -1 || user.suscripciones.indexOf('aerogenerador/energia') !== -1 %}

		var socket = io.connect('http://localhost:3300', { 'forceNew': true });
		socket.on('mapComuna/e', eventFreno);

		function eventFreno(state, id){
			
			for (i = 0; i < makers.length; i++){
				if (id == makers[i].id){
					var e = makers[i];
					if (state == 1) {
						e.icon = '/public/images/boton_rojo.png';
					}
					if (state == 0) {
						e.icon = '/public/images/boton_verde.png';
					}
					map.removeMarker(makers[i]);
					map.addMarker(e);

				}
			}		
		}

	{% endif %}

</script>

<div class="row content">
	<!--<div class="col-md-3 col-md-offset-0">
		 <div class="panel panel-default">
		 	<div class="panel-heading">Lista de Comunas Registradas</div>
            <div class="panel-body">
            	<div class="list-group">

            		{% for comuna in comunas %}
            			<a href="#" onclick="modalShow({{loop.key}})" class="list-group-item">{{comuna.nombre}}</a>
            		{% endfor %}

				</div>
			</div>
		</div>
	</div>-->
	<div class="col-md-12">
		 <div class="panel panel-default">
		 	<div class="panel-heading">Mapa de Comunas</div>
            <div class="panel-body">
				 <div id="map"></div>
			</div>
		</div>
	</div>
</div>
<!-- Ventana Modal de muestreo de datos -->
<div class="modal fade" tabindex="-1" role="dialog" id="modal">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        		<h4 class="modal-title" id="encabezado"></h4>
      		</div>
	      	<div class="modal-body">
	      		<div class="panel panel-default">	
	      			<div class="panel-heading">Información</div>	
					<div class="panel-body">
	      				<div class="col-md-12">
	      					<div class="panel panel-default">
	      						<div class="panel-body">
		      						<h4><strong><u>Datos Generales</u></strong></h4>	
						        	<ul class="list-group list-unstyled">
						        	 	<li>
						        		<strong> Latitud: </strong>
						        		<span class="label label-default" id="latitud"></span><br>
						        		</li>
						        		 <li>
						        		<strong> Longitud: </strong>
						        		<span class="label label-default" id="longitud"></span><br>
						        		</li>
						        		 <li>
						        		<strong> Localidad: </strong>
						        		<span class="label label-default" id="local"></span><br>
						        		</li>
						        		 <li>
						        		<strong> Departamento: </strong>
						        		<span class="label label-default" id="dep"></span><br>
						        		</li>
						        		 <li>
						        		<strong> Cant. de Habiatantes: </strong>
						        		<span class="label label-default" id="habitantes"></span><br>
						        		</li>
						        		 <li>
						        		<strong> Encargado: </strong>
						        		<span class="label label-default" id="encargado"></span><br>		
						        		</li>
						        	</ul>
						        	<!-- <span class="label label-default"> Latitud:</span>
						        		<strong id="latitud"></strong><br>

						        		<span class="label label-default"> Longitud: </span>
						        		<strong id="longitud"></strong><br>

						        		<span class="label label-default"> Localidad: </span>
						        		<strong id="local"></strong><br>

						        		<span class="label label-default"> Departamento: </span>
						        		<strong id="dep"></strong><br>

						        		<span class="label label-default"> Cant. de Habiatantes: </span>
						        		<strong id="habitantes"></strong><br>

						        		<span class="label label-default"> Encargado: </span>
						        		<strong id="encargado"></strong><br>-->
						        </div>
							</div>
						</div>
						<div class="col-md-12">
							<div class="panel panel-default">
								<div class="panel-heading">Equipos de generación instalados</div>
								<!-- Table -->
								<div id="tableG"> </div>
							</div>
						</div>
		      		</div>
		      	</div>
			</div>
	    	<div class="modal-footer">
	        	<button type="button" class="btn btn-primary" data-dismiss="modal">Cerrar</button>
	      	</div>
		</div>
	</div>
</div>

{% endblock %}